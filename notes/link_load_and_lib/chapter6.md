## 可执行文件的装载与进程

### 进程虚拟地址空间

- 程序与进程的区别：静态和动态
- 虚拟地址空间大小：由硬件平台决定，具体由CPU位数决定

- 4G 进程虚拟地址空间分配
    - OS 1GB (0xFFFFFFFF ~ 0xC0000000)
    - User Process 3G (0 ~ 0xC0000000)

- 如果进程地址空间不够，如何访问到 4G 以上？  

### 装载的方式

- 常用部分驻留内存，不常用数据放在磁盘
- 覆盖装入，页映射

#### 覆盖装入
- 按照调用依赖关系，组成树状结构，写覆盖管理器。
- 从模块到根的调用路径，当该模块被调用时，整个调用路径需要在内存中
- 禁止跨树间调用。

#### 页映射
- 将磁盘和内存按照页划分，目前一般说那个4K页

### 从操作系统角度看可执行文件的装载

#### 进程的建立
- 创建进程执行过程：
    - 创建一个独立的进程空间
    - 读取可执行文件头，建立虚拟空间与可执行文件的映射关系
    - 将CPU的指令寄存器设置为可执行文件的入口，启动运行

- 创建一个独立的进程空间：分配一个页目录，虚拟地址到物理内存的映射关系。
- 读取可执行文件头，建立虚拟空间与可执行文件的映射关系：虚拟空间与可执行文件的映射关系
- 将CPU的指令寄存器设置为可执行文件的入口，启动运行：ELF文件头中的entry

- VMA：虚拟内存区域，进程虚拟空间的段

#### 页错误
- 入口地址：0x8048000 + x
- 页错误：

### 进程虚拟空间分布

#### ELF 文件链接视图和执行视图
- OS 只关心装载，段的权限
    - 可读可执行：代码段
    - 可读可写：.bss，数据段
    - 只读：rodata

- 对于相同权限的段，合并到一起当做一个段进程映射
- Segment 包含一个或多个类似的 Section，可以合并在一起作为一个整体映射，减少内部碎片
- 统一映射到VMA


#### 堆和栈
- 进程的堆和栈分别有一个对应的VMA
- 通过`cat /proc/xxx/maps` 可以查看进程的虚拟空间分布
- rwx，p表示私有(COW)，s表示共享


#### 堆的最大申请数量


### Linux 内核装载 ELF 过程简介


### Windows PE 装载

