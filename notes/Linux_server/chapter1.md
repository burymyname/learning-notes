# TCP/IP 协议族

简单介绍相关协议：ICMP ARP DNS

- 系统学协议，看RFC

## TCP/IP 协议族体系结构

- 4 层结构：数据链路，网络，传输，应用

- TODO: 图

### 数据链路层

- 实现网络接口的网络驱动程序，处理物理媒介的数据传输
- 两个常用协议：  
    - ARP：地址解析协议
    - RARP：逆地址解析协议
    - 实现了 IP 到机器物理地址(MAC)的相互转换


### 网络层

- 实现数据包的选路和转发。如何选择中间节点。
- IP 协议：网络层最核心的协议，根据目的 IP 地址决定如何投递。
    - 使用 **hop by hop** 逐跳方式确定通信路径，如果不能直接发给目的主机，则选择合适的下一跳 **(next hop)** 路由器。重复该过程，直到到达或者失败

- ICMP 协议：网络控制报文协议。是 IP 协议的补充，用于检测网络连接。
    - 报文格式
        ```
        +------------+-----------+---------------+
        | 8 bit 类型 | 8 bit 代码 | 16 bit 校验和 |
        +------------+-----------+---------------+
        |           报文内容，取决于报文类型       |
        +----------------------------------------+
        ```
    - 报文类型：8 bit 类型区分，分为 2 类：
        - 差错报文：回应网络错误，目标不可达(3)，重定向(5)
        - 查询报文：查询网络信息，是否可达(8)
    - 报文代码：进一步细分信息条件
    - 校验和：对整个报文包括头部和内容，进行 CRC 校验
    - ICMP 不属于严格意义的网络层协议，使用的是同层 IP 协议提供的服务

### 传输层

- 为应用层提供端到端的通信，只关注起始端和目的端，不在乎过程。
- TCP 和 UDP
    - TCP：传输控制协议。为应用层提供可靠的、面向连接的、基于流的服务。
    - 超时重传，数据确认
    - UDP：用户数据报协议。提供不可靠、无连接、基于数据报的服务。
    - 无法保证可以到达，需要应用自己处理数据确认和重传等。
    

### 应用层

- 主要在用户空间

## 封装

- 封装：应用程序数据沿着协议栈从上往下传递，每层协议在上层数据的基础上加上自己的头部信息以及其他信息，实现该层的功能。

- TODO：图

- TCP封装后为 TCP 报文段，调用 write/send 函数向一个 TCP 连接写入数据时，内核的 TCP 模块将数据复制到内核缓冲区中，调用 IP 模块的服务。

- UDP封装后为 UDP 数据报，UDP 不保存副本，发送后直接丢弃内核缓冲区的数据报。需要用户自行重新发送拷贝

- IP 封装后为 IP 数据报

- 数据链路层封装为帧
    - 格式：
        ```
        | 目的物理地址 | 源物理地址 | 类型 | 数据 | CRC |
        +-------------+-----------+-----+------+-----+
        ```
    - MTU：最大传输单元，1500 byte，表示能够携带的最大上层数据，过长的 IP 数据报需要分片


## 分用

- 分用：即封装的逆过程

- IP ARP RARP 都采用帧传输，所以帧的头部需要某个字段识别区分

- TCP 和 UDP 采用端口号来区分上层应用


## 测试网络

## ARP 协议工作原理

### 以太网 ARP 请求/应答报文详解

### ARP 高速缓存

### `tcpdump` 查看 ARP 过程

## DNS 工作原理

- DNS：域名查询服务。将域名转换为 IP 地址

### DNS 查询和应答报文详解

- 分布式的域名服务系统，每个 DNS 服务器存放大量机器名和 IP 地址映射，且动态更新


## socket

- socket 是内核提供给用户的 API，主要功能：
    - 将用户数据从用户缓冲区复制到内核缓冲区，以交付内核来发送数据；或者从内核 TCP/IP 接收缓冲区复制到用户缓冲区，以读取数据。
    - 修改内核中各层协议的头部信息或者其他数据结构，达到精细控制底层通信的目的。