# IP 协议详解

本章讨论两个问题：
- IP 头部信息
- IP 数据报的理由和转发

## IP 服务的特点

- IP 协议为上层提供：无状态，无连接，不可靠额服务

- 无状态：通信双方不同步传输数据的状态信息，所有 IP 数据报都是独立没有上下文关系的。
    - 缺点：不能处理乱序和重复的 IP 数据报。直接将数据交给上层协议。
    - IP 数据报头部提供一个字段唯一标识 IP 数据报，但是用来处理 IP 分片和重组的。
    - 优点：简单高效，无需为保持通信状态分配内核资源。

- 无连接：通信双方不必长久维持对方的信息，每次发送数据需要指定对方 IP 地址

- 不可靠：尽力交付(best effort)，丢弃或者错误，返回一个 ICMP 错误信息，然后发送端 IP 模块检测到失败，通知上层发送失败，需要上层自行确认和重传

## IPv4 头部结构

### 头部结构

- 长度通常为 20 bytes
    ```
    0                          15                     31
    +-------+--------+---------+----------------------+
    | 版本号 | 头部长 | 服务类型 |  16 bit 总长(字节数)  |
    +-------+--------+---------+----------------------+
    |       16 bit 标识        | 标志 | 13 bit 片偏移  |
    +--------------------------+----------------------+
    |  8 bit TTL  | 8 bit 协议  |  16 bit 头部校验和   |
    +-------------+------------+----------------------+
    |               32 bit 源ip地址                   |
    +-------------------------------------------------+
    |               32 bit 目的ip地址                  |
    +-------------------------------------------------+
    |            option，最多 40 byte                  |
    +-------------------------------------------------+
    ```

- 4 bit 版本号：指定 IP 协议版本，值为 4 表示 IPv4，以及其他扩展版本。
- 4 bit 头部长度：标识 IP 头部有多少个 32 bit 字，4 bit 最大表示 15，故头部最长 15 * 4 = 60 byte
- 8 bit 服务类型：TOS，3 bit 优先权(目前已忽略)，4 bit TOS 字段，分别表示：最小时延，最大吞吐量，最高可靠性，最小费用。其中最多一个能置1，
- 16 bit 总长：整个 IP 数据报长度，以字节为单位。IP 数据报最大长度为 2^16 - 1 = 65535 byte，但是由于 MTU 的限制，长度超过 MTU 的数据报都会被分片传输。
- 16 bit 标识：唯一识别主机发送的每一个数据报，初始值随机，每发送+1，分片会具有相同的标识
- 3 bit 标志：第 1 位保留，第 2 位 DF，表示禁止分片，超过 MTU 会被丢弃并返回 ICMP 差错报文。 第 3 位 MF，表示更多分片，除了数据报的最后一个分片，其他分片需要置 1 
- 13 bit 分片偏移：是分片相对原始 IP 数据报起始的偏移，实际偏移值为该值乘 8，所以除了 IP 最后一个分片以外，其余的分片长度必须是 8 的整数倍。
- 8 bit 生存时间 TTL：数据报到达目的地址之前允许的最大路由器跳数，每经过一个路由，TTL--，当值为 0 时，路由将丢弃数据报。并发送一个 ICMP 差错报文，TTL 的作用是可以防止陷入路由循环。
- 8 bit 协议：区分上层协议。ICMP：1，TCP：6，UDP：17。
- 16 bit 头部校验：由发送端填充，接收端用 CRC 算法校验。
- 32 bit 源 IP 地址
- 32 bit 目的 IP 地址
- option 字段：可选的变长信息，最多 40 字节。
    - 记录路由：告诉数据报途径的路由都将 IP 地址填入 IP 头部可选部分，可以跟踪数据报的传递路径。
    - 时间戳：告诉途经路由将数据报被转发的时间填入，可以测量数据报传输的时间。
    - 松散源路由选择：指定一个路由器 IP 地址列表，数据报发送过程必须经过其中所有的路由器。
    - 严格源路由选择：数据报只能经过指定的路由器。

### 用tcpdump观察 IPv4 头部结构

- TODO：

## IP 分片

- 分片可能发生在发送端，也可能在中转路由器上，而且可能在传输过程被多次分片，但只在目的机器上，分片才会被内核重新组装

- IP 头部为分片提供信息的部分：数据报标识，标志，分片偏移

- MTU 为 1500，除去 IP 头部 20 byte，数据部分最多 1480 byte

- 分片的时候，分的是上层的数据部分，各自加上 IP 头部

## IP 路由

- IP 协议的一个核心任务：决定发送数据报到目的机器的路径

### IP 模块工作流程

- TODO：图

- 当 IP 模块接收到来自数据链路层的 IP 数据报时，首先对头部做 CRC 校验，确认无误后，分析头部信息。
- 如果 IP 数据报头部设置了源站路由选项，则调用数据报转发子模块处理。
- 如果 IP 数据报头部目标 IP 地址是本机的某个 IP 地址或者是广播地址，则是发送给本机的，则 IP 模块根据头部协议字段决定分发给上层哪个应用。
- 如果不是发给本机的，则也转发
- 转发需要先检测系统是否允许转发，不允许则丢弃，允许则转发。

- 路由表：实现 IP 路由的核心。按照数据报的目标 IP 地址进行分类，同类型被发往相同的下一跳路由。

- IP 输出队列：存放等待发送的 IP 数据报，除了转发的，还有本机上层等待发送的

- 路由表更新：通过路由协议，或者 route 协议调整路由表，使之适应最新的网络拓扑结构，称为 IP 路由策略

### 路由机制

- 分类：
    1. 查找路由表和数据报目标 IP 地址完全匹配的主机 IP，找到则使用该路由项
    2. 查找路由表中和数据报目标 IP 地址具有相同网络 ID 的网络 IP 地址
    3. 选择默认路由，一般是网关

### 路由表更新

- 静态更新：`route` 指令
- 动态更新：BGP RIP OSPF 协议

## IP 转发

- 开启主机转发：`echo 1 > /proc/sys/net/ipv4/ip_forward`

- 转发操作：
    1. 检查TTL，为 0 丢弃
    2. 查看 IP 头部路由选项
    3. 如果有必要，发送一个 ICMP 重定向报文给源端，告诉它一个更合理的下一跳路由
    4. TTL--
    5. 处理 IP 头部选项
    6. 如有必要，IP 分片

## 重定向

- ICMP 重定向报文也能用于更新路由表

### ICMP 重定向报文

- 格式
    ```
    +
    | 8 bit 类型 | 8 bit 代码 | 16 bit 校验和    |
    +
    |           应该使用的路由的IP地址
    +
    | 原始IP数据报的头部信息 | 数据部分的前 8 byte |
    ```

- 

### 重定向实例

## IPv6 头部结构
